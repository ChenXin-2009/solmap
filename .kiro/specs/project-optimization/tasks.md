# 治理规范合规性优化实施计划

## 概述

本实施计划将治理规范合规性优化设计转换为一系列可执行的编码任务。每个任务都专注于实现 `.kiro/specs/solmap-ai-governance.md` 中定义的 Spec-0 到 Spec-8 治理规范的自动化检测、修复和监控功能。

系统将使用 TypeScript 实现，重点关注物理系统优先、SSOT 强制执行、层分离验证和渲染层愚蠢化等核心治理原则。

## 任务

- [x] 1. 建立治理规范合规性工具基础架构
  - 创建治理规范检测工具的目录结构
  - 设置 TypeScript 配置和依赖（包括 TypeScript Compiler API）
  - 定义治理规范相关的核心接口和类型
  - 实现 GovernanceSpec、SpecViolation、PhysicsConcept 等基础数据结构
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 1.1 编写基础架构属性测试

  - **属性 1: 治理规范违规检测完整性**
  - **验证: 需求 1.1, 1.2, 1.3, 1.4, 1.5**

- [x] 2. 实现治理规范分析器 (GovernanceAnalyzer)
  - [x] 2.1 创建项目 AST 解析和治理规范配置加载
    - 使用 TypeScript Compiler API 解析项目源码
    - 加载和解析 solmap-ai-governance.md 中的规范定义
    - 构建项目文件的抽象语法树和依赖图
    - _需求: 1.1, 1.2_

  - [ ]* 2.2 编写治理规范分析属性测试
    - **属性 1: 治理规范违规检测完整性**
    - **验证: 需求 1.1, 1.2, 1.3, 1.4, 1.5**

  - [x] 2.3 实现 Spec-0 最高约束检测
    - 检测违反物理系统优先原则的代码
    - 识别同一问题的重复修改模式
    - 检测结构性失败的早期征象
    - _需求: 1.1, 5.1, 5.2, 5.3_

  - [ ]* 2.4 编写 Spec-0 检测属性测试
    - **属性 5: 结构性失败预防有效性**
    - **验证: 需求 5.1, 5.2, 5.3, 5.4, 5.5**

- [-] 3

  - [x] 3.1 检查点 - 确保治理规范分析器正常工作
    - 确保所有测试通过，如有问题请询问用户

- [x] 4. 实现 SSOT 违规检测器 (SSOTViolationDetector)
  - [x] 4.1 实现物理常量重复定义检测
    - 检测轴倾角、物理参数、周期、参考系的重复定义
    - 验证所有物理概念只有唯一权威定义点
    - 识别违反 lib/astronomy/constants/ 目录结构的定义
    - _需求: 2.1, 2.2, 2.3, 2.4, 2.5_

  - [ ]* 4.2 编写 SSOT 检测属性测试
    - **属性 2: SSOT 原则强制执行准确性**
    - **验证: 需求 2.1, 2.2, 2.3, 2.4, 2.5**

  - [x] 4.3 实现权威定义验证
    - 验证 axialTilt.ts、physicalParams.ts、rotation.ts、referenceFrames.ts 的权威性
    - 检测从非权威源获取物理数据的代码
    - 确保常量文件的纯净性（只包含常量，无逻辑）
    - _需求: 2.1, 2.2, 2.3, 2.4, 7.1, 7.2_

  - [ ]* 4.4 编写权威定义验证属性测试
    - **属性 7: 常量文件纯净性维护严格性**
    - **验证: 需求 7.1, 7.2, 7.3, 7.4, 7.5**

- [x] 5. 实现层分离验证器 (LayerSeparationValidator)
  - [x] 5.1 创建架构层定义和跨层检测
    - 定义 RENDERING、PHYSICS、ASTRONOMY、CONSTANTS、INFRASTRUCTURE 层
    - 检测违反层分离的跨层 import 和依赖
    - 验证依赖方向符合架构设计
    - _需求: 6.1, 6.2, 6.3, 6.4, 6.5_

  - [ ]* 5.2 编写层分离验证属性测试
    - **属性 6: 层分离强制执行准确性**
    - **验证: 需求 6.1, 6.2, 6.3, 6.4, 6.5**

  - [x] 5.3 实现单一职责和接口边界检查
    - 检测违反单一职责原则的模块
    - 验证模块间接口的清晰性和一致性
    - 拒绝"能跑但结构错误"的代码实现
    - _需求: 6.3, 6.4, 6.5_

- [x] 6. 检查点 - 确保 SSOT 和层分离检测功能完整
  - 确保所有测试通过，如有问题请询问用户

- [x] 7. 实现渲染层愚蠢化检查器 (RendererStupidityChecker)
  - [x] 7.1 实现渲染器输入和知识边界检查
    - 确保渲染器只接收位置向量、姿态矩阵和可视参数
    - 检测渲染器中的轴倾角、周期或参考系知识
    - 禁止渲染器导入物理常量或计算模块
    - _需求: 3.1, 3.2, 3.3_

  - [ ]* 7.2 编写渲染层愚蠢化属性测试
    - **属性 3: 渲染层愚蠢化验证严格性**
    - **验证: 需求 3.1, 3.2, 3.3, 3.4, 3.5**

  - [x] 7.3 实现渲染层计算逻辑检测
    - 识别渲染层中的角度或周期计算
    - 检测渲染器中的物理推导或数据解释逻辑
    - 确保渲染器职责边界的严格维护
    - _需求: 3.4, 3.5_

- [x] 8. 实现魔法数字检测器 (MagicNumberDetector)
  - [x] 8.1 实现硬编码常量检测
    - 扫描函数内部的硬编码物理常量
    - 检测硬编码的角度值、周期数据、比例因子
    - 确保所有物理数据都通过 import 获取
    - _需求: 4.1, 4.2, 4.3, 4.4_

  - [ ]* 8.2 编写魔法数字检测属性测试
    - **属性 4: 魔法数字检测全面性**
    - **验证: 需求 4.1, 4.2, 4.3, 4.4, 4.5**

  - [x] 8.3 实现配置值来源和单位检查
    - 确保配置值都有明确的来源和单位
    - 检测缺少单位或参考系的数值
    - 提供权威来源的修复建议
    - _需求: 4.5_

- [x] 9. 检查点 - 确保渲染层和魔法数字检测功能完整
  - 确保所有测试通过，如有问题请询问用户

- [x] 10. 实现结构性失败检测器 (StructuralFailureDetector)
  - [x] 10.1 实现修改历史分析和不稳定性检测
    - 分析代码修改历史，识别同一问题被修改≥3次的区域
    - 检测测试通过但视觉/数值不稳定的实现
    - 识别"为了看起来对"的调参行为
    - _需求: 5.1, 5.2, 5.3_

  - [ ]* 10.2 编写结构性失败检测属性测试
    - **属性 5: 结构性失败预防有效性**
    - **验证: 需求 5.1, 5.2, 5.3, 5.4, 5.5**

  - [x] 10.3 实现重构需求识别和流程触发
    - 标记需要结构性重构的代码区域
    - 提供冻结功能开发的建议
    - 生成重构计划和风险评估
    - _需求: 5.4, 5.5_

- [x] 11. 实现架构修复引擎 (ArchitectureRepairEngine)
  - [x] 11.1 实现 SSOT 违规修复
    - 自动将重复定义迁移到权威定义点
    - 生成符合 SSOT 原则的重构方案
    - 修复常量文件的纯净性违规
    - _需求: 2.1, 2.2, 2.3, 2.4, 2.5, 7.1, 7.2_

  - [x] 11.2 实现层分离和渲染层修复
    - 修复跨层导入和依赖违规
    - 将渲染层中的物理逻辑移至正确层级
    - 愚蠢化渲染器实现
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5, 6.1, 6.2_

  - [ ]* 11.3 编写架构修复属性测试
    - **属性 2: SSOT 原则强制执行准确性**
    - **属性 3: 渲染层愚蠢化验证严格性**
    - **属性 6: 层分离强制执行准确性**
    - **验证: 需求 2.1-2.5, 3.1-3.5, 6.1-6.5**

  - [x] 11.3 实现魔法数字消除和结构性重构
    - 将硬编码常量替换为权威定义的引用
    - 触发结构性重构流程
    - 生成开发冻结建议
    - _需求: 4.1, 4.2, 4.3, 4.4, 4.5, 5.4, 5.5_

- [-] 12. 检查点 - 确保架构修复引擎功能完整
  - 确保所有测试通过，如有问题请询问用户

- [ ] 13. 实现 AI 自检流程 (AIPreCommitChecker)
  - [ ] 13.1 创建自检问题和验证流程
    - 实现"是否引入了新的定义点"检查
    - 验证"数值的单位与参考系是否明确"
    - 检查"计算是否属于正确的层级"
    - 评估"是否破坏了现有架构"
    - _需求: 8.1, 8.2, 8.3, 8.4_

  - [ ]* 13.2 编写 AI 自检流程属性测试
    - **属性 8: AI 自检流程完整性**
    - **验证: 需求 8.1, 8.2, 8.3, 8.4, 8.5**

  - [ ] 13.3 实现提交阻止和人工审查机制
    - 在无法回答关键问题时禁止代码提交
    - 要求人工审查的升级机制
    - 生成详细的自检报告
    - _需求: 8.5_

- [ ] 14. 实现治理规范教育和建议系统
  - [ ] 14.1 创建违规教育和修复建议
    - 提供具体的治理规范引用和解释
    - 生成符合 SSOT 原则的重构方案
    - 解释违规代码对系统稳定性的影响
    - _需求: 9.1, 9.2, 9.3_

  - [ ]* 14.2 编写教育建议属性测试
    - **属性 9: 治理教育建议准确性**
    - **验证: 需求 9.1, 9.2, 9.3, 9.4, 9.5**

  - [ ] 14.3 实现重构指导和最佳实践
    - 提供将违规代码迁移到正确位置的步骤
    - 提供最佳实践建议和模板
    - 预防未来违规的指导
    - _需求: 9.4, 9.5_

- [ ] 15. 实现持续监控和报告系统
  - [ ] 15.1 创建合规性报告和监控
    - 生成详细的违规统计和趋势分析
    - 在每次提交时验证治理规范合规性
    - 记录违规修复的历史和效果
    - _需求: 10.1, 10.2, 10.3_

  - [ ]* 15.2 编写持续监控属性测试
    - **属性 10: 持续监控报告完整性**
    - **验证: 需求 10.1, 10.2, 10.3, 10.4, 10.5**

  - [ ] 15.3 实现架构健康度评估和预警
    - 提供整体架构质量的量化指标
    - 在问题达到结构性失败阈值前发出警告
    - 生成架构演化趋势报告
    - _需求: 10.4, 10.5_

- [ ] 16. 实现合规性验证器和错误恢复
  - [ ] 16.1 创建治理规范合规性验证器
    - 验证修复后的代码严格遵循治理规范
    - 确保架构修复不破坏其他架构约束
    - 验证功能保持和性能影响
    - _需求: 所有需求的验证_

  - [ ] 16.2 实现治理规范错误恢复机制
    - 处理 Spec-0 违规的开发冻结
    - SSOT 违规的自动重构回滚
    - 结构性失败的重构流程触发
    - _需求: 所有需求的错误处理_

- [ ] 17. 集成和命令行界面
  - [ ] 17.1 创建治理规范检查命令行工具
    - 实现治理规范检查命令和选项
    - 提供治理规范配置文件支持
    - 生成治理规范合规性报告
    - _需求: 所有需求的用户接口_

  - [ ] 17.2 实现治理规范配置管理
    - 支持项目级治理规范配置
    - 提供治理规范严格性级别设置
    - 实现治理规范排除规则
    - _需求: 1.1, 1.2, 1.3, 1.4, 1.5_

  - [ ]* 17.3 编写集成测试
    - 测试完整的治理规范检查流程
    - 验证命令行界面功能
    - 测试多规范冲突处理

- [ ] 18. 最终检查点 - 完整治理规范系统验证
  - 运行所有测试套件
  - 在实际 SolMap 项目上测试治理规范工具
  - 验证所有治理规范检查功能正常工作
  - 确保所有测试通过，如有问题请询问用户

## 注意事项

- 每个任务都引用了具体的治理规范需求以确保可追溯性
- 检查点确保增量验证和治理规范合规性
- 属性测试验证治理规范的通用正确性属性
- 单元测试验证具体的治理规范违规场景和边界条件
- 标记为 "*" 的测试任务是可选的，可以跳过以加快核心功能开发
- 所有实现都必须严格遵循 Spec-0 到 Spec-8 的治理规范
- 系统的稳定性来自结构，而不是聪明实现
- 任何破坏治理规范的改动，即使功能正确，一律视为失败实现